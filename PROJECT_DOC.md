# LinkPet 项目说明文档

## 1. 项目简介 (Introduction)

**LinkPet** 是一款基于生成式 AI (Generative AI) 的**智能情感陪伴虚拟宠物游戏**。

与传统的"电子宠物"不同，LinkPet 的核心愿景是**赋予虚拟角色"灵魂"**。宠物不仅仅是需要喂食的程序，而是拥有独立人格、记忆和自主行为的智能体 (Agent)。它通过心理测试孵化出与主人性格互补或相似的专属宠物，并能在自主的"旅行"中生成独特的见解和照片，通过对话建立深厚的情感连接。

**核心解决的问题：**
*   **孤独感与情感寄托**：为现代都市人提供一个随时在线、能够深度理解并记忆用户喜好的情感伴侣。
*   **游戏体验的同质化**：打破传统养成游戏千篇一律的脚本化体验，通过 AI 创造无限可能的互动内容。

---

## 2. 业务价值说明 (Business Value)

### 对用户的价值
*   **深度情感陪伴**：宠物基于 LLM（大语言模型）驱动，能进行非结构化的自然语言对话，记住用户的名字、喜好和过往经历，提供真正的"被理解感"。
*   **专属定制体验**：通过孵化阶段的心理测试（MBTI 维度映射），每个用户获得的宠物性格（如“高冷极客黑猫”或“社牛话痨松鼠”）都是独一无二的。
*   **惊喜感与期待感**：宠物的自主旅行机制（类似于《旅行青蛙》但内容由 AI 生成）创造了不确定的惊喜，用户永远不知道宠物会带回什么样的日记和见解。

### 对业务的价值
*   **高用户留存 (Retention)**：自主行为机制（宠物会自己去睡觉、旅行）利用了"间歇性强化"心理学原理，促使用户频繁打开应用查看宠物状态。
*   **内容自动化 (Scalability)**：利用 AIGC 技术自动生成日记、对话和配图，极大降低了游戏内容的生产成本，理论上拥有无限的游戏时长。
*   **数据驱动的迭代**：通过分析用户与宠物的对话数据（在隐私合规前提下），可以持续优化模型的人格表现和互动策略。

---

## 3. AI 创新性说明 (AI Innovation)

AI 不仅仅是 LinkPet 的辅助工具，而是**核心驱动力**。

### 3.1 人格映射引擎 (Personality Engine)
*   **机制**：在孵化阶段，通过 6 道心理测试题，分析用户的性格特征（如内向/外向、探索欲等）。
*   **AI 应用**：系统利用向量算法计算用户特征与预设宠物模板（Quokka, Red Panda, Black Cat 等）的匹配度，不仅决定宠物的外观，更注入了基于 MBTI 的 System Prompt（系统提示词），奠定宠物的"基调"。

### 3.2 自主智能体架构 (Autonomous Agent)
*   **机制**：宠物不再完全依赖用户指令。它拥有自己的"意愿"。
*   **AI 应用**：
    *   **概率状态机**：基于宠物的性格参数（如`exploration`探索欲, `extroversion`外向度），AI 动态计算宠物当前应该去"睡觉"、"吃饭"还是"旅行"。
    *   例如，一只高探索欲的“仓鼠”会比一只懒惰的“考拉”更频繁地外出旅行。

### 3.3 RAG 驱动的记忆对话 (Memory-Augmented Chat)
*   **机制**：宠物能记住以前聊过的话题以及**过往的旅行经历**。
*   **AI 应用**：
    *   **RAG (检索增强生成)**：将用户的对话历史和**宠物的旅行日记**向量化存储。
    *   **记忆检索**：当用户发起新话题或宠物生成新日记时，系统不仅检索对话记录，还会检索相似的过往旅行经历。例如，当宠物再次去"海边"时，它会回想起上次去海边发生的趣事，并在日记或对话中提及，构建连贯的时间线。

### 3.4 多模态日记生成 (Multimodal Diary Generation)
*   **机制**：宠物旅行归来会带回图文并茂的日记。
*   **AI 应用**：
    *   **文本生成**：LLM 扮演宠物角色，根据旅行地点（如"火山"、"图书馆"）和发生的时间，生成符合其性格口吻的日记内容。
    *   **图像合成**：系统将宠物形象与场景背景进行智能合成（未来可接入 Stable Diffusion 生成全新场景），生成独特的旅行照片。

### 3.5 宠物社交与匹配 (Pet Social System)
*   **机制**：用户的宠物之间具备社交功能。
*   **AI 应用**：
    *   **智能匹配算法**：系统根据宠物的性格维度（MBTI、探索欲等）计算匹配度。算法既支持**相似性格**匹配（寻找共鸣），也支持**差异性格**匹配（制造反差萌），增加互动的趣味性和不确定性。
    *   **社交互动**：宠物在"旅行"途中可能会遇到其他用户的宠物，并带回关于新朋友的描述，进一步增强产品的社交属性。

---

## 4. 技术实现说明 (Technical Implementation)

LinkPet 采用现代化的前后端分离架构，核心是 **Python FastAPI 后端** 与 **Next.js 前端** 的结合。

### 4.1 整体架构
*   **Frontend**: Next.js (React), Tailwind CSS, Framer Motion (动画交互)。
*   **Backend**: Python FastAPI (高性能异步框架)。
*   **Database**: SQLite (轻量级数据存储，便于部署)。
*   **AI Model Layer**: 接入 ModelScope (阿里魔搭社区) 的开源模型：
    *   **LLM**: `Qwen/Qwen2.5-Coder-7B-Instruct` (用于对话和文本生成)。
    *   **Embedding**: `Qwen/Qwen3-Embedding-8B` (用于记忆向量化)。

### 4.2 核心模块 (Core Modules & Algorithms)

#### 4.2.1 Game Engine (游戏引擎) - `hatching.py` & `behavior.py`

游戏引擎负责驱动宠物的“生命周期”和“日常行为”，核心算法如下：

**1. 孵化与性格映射算法 (Hatching & Personality Mapping)**
*   **输入**: 用户回答的 6 个情境选择题（如环境偏好、声音偏好等）。
*   **中间层**: 将每个回答映射为 4 个维度的性格特征值变化：
    *   **Rebellion (叛逆度)**: 影响是否听话、喜欢刺激。
    *   **Extroversion (外向度)**: 影响社交频率、喜欢热闹还是安静。
    *   **Exploration (探索欲)**: 影响旅行频率、去新地方的概率。
    *   **Affinity (亲和力)**: 影响与人互动的态度。
*   **输出 (欧氏距离匹配)**: 
    *   系统预设了 7 种宠物模板（Quokka, Red Panda, Squirrel, White Rabbit, Hedgehog, Hamster, Black Cat），每种都有固定的 4 维特征向量。
    *   计算用户的**累积特征向量**与所有**模板特征向量**之间的**欧氏距离 (Euclidean Distance)**。
    *   选择距离最近（最相似）的模板作为用户的专属宠物。
    *   公式：`Distance = sqrt((u_reb - t_reb)^2 + (u_ext - t_ext)^2 + ...)`

**2. 行为状态机与概率转移 (Behavior State Machine)**
*   **状态定义**: `SLEEPING` (睡觉), `EATING` (吃饭), `TRAVELING` (旅行)。
*   **触发机制**: APScheduler 每 3 分钟运行一次 `update_pet_behavior`。
*   **转移逻辑**:
    *   **最小持续时间 (Min Duration)**: 任何状态至少保持 5 分钟 (300s)，避免频繁切换。
    *   **基于性格的概率权重**:
        *   `travel_weight = 0.1 + (exploration * 0.4)` (探索欲越高，越爱出门)。
        *   `eat_weight = 0.2 + (extroversion * 0.2)` (外向度越高，越活跃/贪吃)。
        *   `sleep_weight = 0.5` (基础权重)。
    *   **轮盘赌选择 (Roulette Wheel Selection)**: 根据权重计算各状态的概率区间，生成 0-1 随机数决定下一状态。

**3. 旅行目的地选择 (Destination Selection)**
*   **优先探索新地点**: 80% 的概率优先选择**未去过**的地标 (Landmarks)。
*   **重游旧地**: 20% 的概率，或者所有地标都去过后，从所有场景 (Scenes + Landmarks) 中随机选择。
*   **防重复机制**: 利用 SQLAlchemy 的 `flag_modified` 确保 `visited_landmarks` 列表正确持久化，避免“失忆”导致反复去同一个已去过的地标。

**4. 社交相遇算法 (Social Encounter Algorithm)**
*   **触发**: 当两只宠物同时处于 `TRAVELING` 状态且位于**同一地点**时。
*   **匹配概率**: `Base (0.3) + Similarity Bonus + Contrast Bonus`
    *   **相似相吸**: 性格特征距离 < 0.2，概率加成 (最高 +0.4)。
    *   **互补相吸**: 性格特征距离 > 0.8，概率加成 (最高 +0.4)。
    *   这意味着性格极度相似或极度不同的宠物更容易成为朋友。

#### 4.2.2 Agent Service (智能体服务)

智能体服务赋予宠物记忆、感知和表达能力，是“灵魂”所在。

**1. 记忆系统 (Memory System) - `memory.py`**
*   **存储机制**: 使用 SQLite 存储记忆条目 (`Memory` Model)。由于 SQLite 原生不支持向量检索，采用 JSON 字段存储 Embedding 向量。
*   **向量化**: 调用 `llm_service.get_embedding` 接口 (后端对接 `Qwen/Qwen3-Embedding-8B`) 将文本转化为向量。
*   **检索算法 (RAG)**:
    *   **上下文检索**: 在生成日记时，提取当前场景、事件作为 Query。
    *   **余弦相似度 (Cosine Similarity)**: 从数据库拉取所有 `trip_log` 类型的记忆，在内存中计算 Query 向量与记忆向量的相似度。
    *   **Top-K 召回**: 选取相似度最高的 5 条历史记忆注入 Prompt，确保宠物的语气和经历具有连续性。
*   **统计性记忆**: 通过 SQL 聚合查询判断“首次事件” (First-time Visit / First-time Encounter)，动态调整 Prompt 中的上下文描述 (如“这是你第一次来...” vs “你对这里很熟悉...”)。

**2. 叙事生成 (Narrator) - `behavior.py` (Core Logic)**
*   **Prompt Engineering (提示词工程)**:
    *   **性格注入**: 将量化的性格数值 (Rebellion, Affinity 等) 转化为具体的行为指导 (如“表现得傲娇”、“喜欢热闹”)。
    *   **约束控制**: 严格禁止幻觉 (Hallucination)，例如通过 `interaction_instruction` 动态插入约束，禁止编造不存在的虚构动物，仅允许与实际匹配到的 Partner 互动。
    *   **场景感知**: 结合视觉模型生成的场景描述，让宠物能描述环境细节。
*   **反思与表达**: 大模型根据输入的三元组 (Who, Where, What) + 历史记忆 + 性格设定，生成第一人称的日记内容。

**3. 大模型基础设施 (LLM Infrastructure) - `llm_service.py`**
*   **统一接口**: 封装 OpenAI 兼容接口，对接 ModelScope 上的 `Qwen/Qwen2.5-Coder-7B-Instruct`。
*   **高可用设计**:
    *   **熔断与降级 (Fallback)**: 当请求失败时，自动降级返回预设的安全回复 (如 "Meow...") ，防止服务崩溃。


#### 4.2.3 Interaction Layer (交互层)
*   RESTful API (`/api/v1/...`) 处理前端请求。
*   WebSocket (规划中) 用于实时状态推送。

---

## 5. 交互与设计说明 (Interaction & Design)

设计风格：**手绘风 (Hand-Drawn)**，营造温馨、轻松、不完美的真实感。

### 5.1 关键用户流程 (User Flow)

1.  **孵化 (The Hatching)**
    *   **界面**：一颗放置在环境中的蛋。
    *   **交互**：用户回答 6 个情境问题（如"你会带它去哪里玩？"），每次回答都会为蛋增加"热量"。
    *   **高潮**：热量充满，蛋壳碎裂，光芒中诞生专属宠物，并进入取名环节。

2.  **家 (The Home)**
    *   **界面**：宠物的主场景。背景随宠物状态变化（或旅行中显示空荡荡的家）。
    *   **交互**：
        *   **查看状态**：宠物在睡觉、吃饭或发呆。
        *   **功能入口**：聊天、查看日记。
    *   **彩蛋**：点击宠物会有独特的动作反馈。

3.  **旅行与日记 (Travel & Diary)**
    *   **流程**：
        1.  宠物自主决定离家（Home 界面显示"旅行中"）。
        2.  用户无法强制召回，只能等待（建立牵挂感）。
        3.  宠物归来，弹窗提示"我给你带了礼物！"。
        4.  用户打开日记，看到一张合成照片和一段基于宠物性格生成的见闻（如"今天在图书馆看到一本好书，想到了你..."）。

4.  **聊天 (Chat)**
    *   **界面**：类似于微信/短信的对话框。
    *   **交互**：用户发送文字，宠物秒回。宠物会引用之前的对话内容（"上次你说你喜欢吃苹果..."），展现记忆能力。

## 6. 未来规划与商业化 (Future Roadmap & Commercialization)

LinkPet 致力于打造一个长生命周期的情感元宇宙。

### 6.1 深度社交系统 (Social Evolution)
*   **用户间对话开启**：通过宠物作为破冰介质。当两只宠物在旅行中多次相遇或互动后，它们的主人（用户）之间可以解锁聊天功能。这种基于"缘分"的社交方式比直接匹配更自然、更具粘性。
*   **社交关系沉淀**：通过宠物建立的社交关系链是产品的高壁垒，能显著增加用户粘性 (Retention) 和迁移成本。

### 6.2 商业化体系 (Commercialization)
*   **装备与饰品系统**：开放商城功能，允许用户为宠物购买虚拟装备（如旅行背包、相机）和饰品（如帽子、围巾）。
    *   **外观价值**：满足用户的个性化装扮需求。
    *   **功能价值**：特定装备可能影响旅行结果（例如，带着"相机"旅行有更高概率带回稀有照片）。
    *   **盈利模式**：作为核心的商业变现手段，支持微交易。

### 6.3 开放世界拓展
*   引入更多样化的旅行场景（如异次元、历史遗迹）。
*   支持用户共建场景和剧情。

---
*LinkPet 不仅仅是一个游戏，它是 AI 技术在情感陪伴领域的一次温情探索。*
